---
title: Test Integration Services (TIS) Installation Checklist
permalink: "/deployment/checklist/tis.html"
layout: "document"
categories: ["deployment", "checklist", "tds"]
---

## Overview

| Item | Description |
|:-----|:------------|
| Purpose | Integration for assessment scoring |
| Communicates With | ART, Student, Equation Scoring Service, THSS |
| Repository Location | [https://bitbucket.org/sbacoss/testintegrationsystem_release](https://bitbucket.org/sbacoss/testintegrationsystem_release) |
| Additional Documentation | [TIS REST API](https://bitbucket.org/sbacoss/testintegrationsystem_release/src/a4efcfaad21c7dd154b8ab04bf452e0899c9aa13/TISServices/Documentation/TIS%20REST%20API.txt?at=default&fileviewer=file-view-default), [README](https://bitbucket.org/fwsbac/testintegrationsystem_release) |

## Instructions

### Create MSSQL RDS Instance
* Create a MSSQL RDS Instance using a MSSQL Server Edition that suits the environment's needs
  * Choose at least a **SQL Server Web** instance
  * Configure the MSSQL RDS Instance based on the environment's needs:
    * [Documentation for setting up an AWS MSSQL Server instance](http://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_ConnectToMicrosoftSQLServerInstance.html)

### Create TIS Databases
* Create the following databases on the MSSQL Server:
  * `OSS_TIS`
  * `OSS_Itembank`
  * `OSS_Configs`
  * `OSS_TestScoringConfigs`

#### Create TIS Databse User Account(s)
* Create a user account (i.e. an MSSQL login or an Active Directory user) that has access to read/write (`db_reader` and `db_writer` roles) for the databases cited above.

#### Create the OSS_TIS Database Schema
* Run the following scripts in order against the `OSS_TIS` database:
  1. [*\Path\to\TIS Repository*{: style="color: #f00;"}]`\TDSQAService\OSS.TIS\SQL\TISDB\1_Create_Objects.sql`
  2. [*\Path\to\TIS Repository*{: style="color: #f00;"}]`\TDSQAService\OSS.TIS\SQL\TISDB\2_Configuration_IAB Tests.sql`
  3. [*\Path\to\TIS Repository*{: style="color: #f00;"}]`\TDSQAService\OSS.TIS\SQL\TISDB\2_Configuration_ICA_OP Tests.sql`
  4. [*\Path\to\TIS Repository*{: style="color: #f00;"}]`\TDSQAService\OSS.TIS\SQL\TISDB\3_ScoringDaemonConfiguration.sql`
  5. [*\Path\to\TIS Repository*{: style="color: #f00;"}]`TDSQAService\OSS.TIS\SQL\TISDB\4_IRP_DataLoad.sql`

      **IMPORTANT:**{: style="color: #f00"} *The `3_ScoringDaemonConfiguration.sql` script will require configuration prior to execution.  Before executing the script, open it in an editor and configure the following:*{: style="background-color: #ff0;"}

<div class="highlighter-rouge">
<pre class="highlight">
<code>-- these can be IP or server name
set @IP = '[<span class="placeholder">FQDN or IP address of the database server</span>]'
set @privateIP = '[<span class="placeholder">Private IP address of the database server</span>]' -- can be different if you want to use a private IP
set @dbname = '[<span class="placeholder">Name of the TIS database; use <strong>OSS_TIS</strong> if following this guide</span>]'
set @scoringDaemonName = '[<span class="placeholder">Name of the TIS Scoring Daemon.  Should match the value in <strong>settings.config</strong> for <strong>ScoringDaemon.MachineName</strong></span>]'
set @itemScoringHost = '[<span class="placeholder">FQDN or IP address of the Item Scoring Server</span>]/itemscoring/Scoring'
set @rubricCallbackHost = 'https://[<span class="placeholder">FQDN or IP address of the Rubric Server</span>]/student/'</code>
</pre>
</div>

* Example configuration:

<div class="highlighter-rouge">
<pre class="highlight">
<code>-- these can be IP or server name
set @IP = '<span class="placeholder-example">tis-deployment2.cugsexobhx8t.us-west-2.rds.amazonaws.com</span>'
set @privateIP = '<span class="placeholder-example">tis-deployment2.cugsexobhx8t.us-west-2.rds.amazonaws.com</span>' -- can be different if you want to use a private IP
set @dbname = '<span class="placeholder-example">OSS_TIS</span>'
set @scoringDaemonName = '<span class="placeholder-example">MyTISScoringDaemon</span>'
set @itemScoringHost = '<span class="placeholder-example">54.200.55.254:8080</span>/itemscoring/Scoring'
set @rubricCallbackHost = 'https://<span class="placeholder-example">54.200.55.254</span>/student/'</code>
</pre>
</div>

#### Create the OSS_TestScoringConfigs Database Schema
* Run the following scripts in order against the `OSS_TestScoringConfigs` database:
  1. [*\Path\to\TIS Repository*{: style="color: #f00;"}]`\TDSQAService\OSS.TIS\SQL\TestScoringConfigs\1_Tables.sql`
  2. [*\Path\to\TIS Repository*{: style="color: #f00;"}]`\TDSQAService\OSS.TIS\SQL\TestScoringConfigs\2_Views.sql`
  3. [*\Path\to\TIS Repository*{: style="color: #f00;"}]`\TDSQAService\OSS.TIS\SQL\TestScoringConfigs\3_Configuration.sql`

#### Create the OSS_Configs Database Schema
* Run the following scripts in order against the `OSS_Configs` database:
  1. [*\Path\to\TIS Repository*{: style="color: #f00;"}]`\TDSQAService\OSS.TIS\SQL\TDSConfigs\1_Create_Objects.sql`

      **NOTE:** Ignore the SQL warnings returned by this script

  2. [*\Path\to\TIS Repository*{: style="color: #f00;"}]`\TDSQAService\OSS.TIS\SQL\TDSConfigs\2_Configuration.sql`

#### Create the OSS_Itembank Database Schema
* Run the following scripts in order against the `OSS_Itembank` database:
1. [*\Path\to\TIS Repository*{: style="color: #f00;"}]`\TDSQAService\OSS.TIS\SQL\TDSItemBank\1_Create_Synonyms_Sproc.sql`
2. [*\Path\to\TIS Repository*{: style="color: #f00;"}]`\TDSQAService\OSS.TIS\SQL\TDSItemBank\2_Create_Synonyms_Config.sql`

    **IMPORTANT:**{: style="color: #f00;"} *The `3_ScoringDaemonConfiguration.sql` script will require configuration prior to execution  Before executing the script, open it in an editor and configure the following:*{: style="background-color: #ff0;"}

<div class="highlighter-rouge">
<pre class="highlight">
<code>-- TODO: set these to the database names you created
set @TDSConfigsDatabaseName = '<span class="placeholder">[Name of the TIS Configuration database; use <strong>OSS_Configs</strong> if following this guide]</span>'
set @TestScoringConfigsDatabaseName = '<span class="placeholder">[Name of the Test Scoring Configuration database; use <strong>OSS_TestScoringConfigs</strong> if following this guide]</span>'</code>
</pre>
</div>

* Example configuration:

<div class="highlighter-rouge">
<pre class="highlight">
<code>-- TODO: set these to the database names you created
set @TDSConfigsDatabaseName = '<span class="placeholder-example">OSS_Configs</span>'
set @TestScoringConfigsDatabaseName = '<span class="placeholder-example">OSS_TestScoringConfigs</span>'</code>
</pre>
</div>

3. [*\Path\to\TIS Repository*{: style="color: #f00;"}]`\TDSQAService\OSS.TIS\SQL\TDSItemBank\3_Create_Objects.sql`
4. [*\Path\to\TIS Repository*{: style="color: #f00;"}]`\TDSQAService\OSS.TIS\SQL\TDSItemBank\4_Configuration.sql`
5. [*\Path\to\TIS Repository*{: style="color: #f00;"}]`\TDSQAService\OSS.TIS\SQL\TDSItemBank\5_LoadPackages.sql`
6. [*\Path\to\TIS Repository*{: style="color: #f00;"}]`\TDSQAService\OSS.TIS\SQL\TDSItemBank\6_TestToolConfiguration.sql`

    **NOTE:** The "context" values may not be valuable; they should be treated as sample data (many test names do not match what is available from the SBAC FTP site)

### Create AWS Instance
* Create server instance to host Test Itegration Services (TIS) components
  * AWS instance must be at least a **t2.small**
  * Select an image with the **Windows Server 2012 R2 Base**{: style="color: #04384e"} 64-bit operating system
* Create an AWS security group with the following ports for inbound TCP traffic (can be done during instance creation):
  * 1433
  * 80
  * 3389
  * 443

### Configure Windows AWS Instance
{% include checklist/windows_server_config.md %}

## Deploy the TDS Receiver

### Build the TDS Receiver
* Clone the TIS repository to a machine that can build .NET applications:
  * `hg clone https://`[*your BitBucket user or team name*{: style="color: #f00;"}]`/sbacoss/testintegrationsystem_release`
  * Example:
    * `hg clone https://`<span class="placeholder-example">jjohnson-fw@bitbucket.org</span>`/sbacoss/testintegrationsystem_release`
* Launch Visual Studio
* Open the `TISServices/TISServices/TISServices.sln`

{% include checklist/windows_vs_publish.md %}

### Deploy the TDS Receiver
* Connect to the AWS Windows server via RDP
* Create a directory where the TDS Receiver component will be deployed
  * The TDS Receiver is a web application, thus must be accessible by IIS
  * Example:  `C:\inetpub\`<span class="placeholder-example">tds_receiver</span>
* From the machine where the TDS Receiver was built, copy the *entire contents* of the directory where the **Publish** wizard deployed the component into the directory created in the previous step.

### Configure a TDS Receiver Website in IIS
* Launch the **Internet Information Services Manager**
  * Click **Start** button in lower-left corner (leftmost control on toolbar)
  * Click the down arrow (if the **Internet Information Services Manager** does not appear)
  * Search for and launch the **Internet Information Services Manager**
* Right click on the **Default Web Site**
  * Choose **Manage Website...**
  * Choose **Stop**
* Right click on **Sites** and choose **Add Website...**

![Add website within IIS](/res/images/checklist/iis_01_add_site.png){: width="100%"}

* Provide the following details in the dialog that appears:
  * Site name: [*Choose a meaningful name*{: style="color: #f00;"}]
  * Application Pool: [*Choose an exisitng Application Pool, or allow IIS to create a new Application Pool for this site (**recommended**)*{: style="color: #f00;"}]
  * Physical Path: [*The path to where the TDS Receiver components have been deployed*{: style="color: #f00;"}]
  * Binding:  [*Choose an available port*{: style="color: #f00;"}]
  * Host name:  [***OPTIONAL:*** *Provide a host name*{: style="color: #f00;"}]

* Screenshot showing example values for the TDS Receiver website:

![Add website details](/res/images/checklist/iis_02_tds_receiver_site_details.png){: width="100%"}

### Configure the TDS Receiver Application
* Edit the [*Path\to\TDS Receiver*{: style="color: #f00;"}]`web.config` file
  * Example:  Edit the <span class="placeholder-example">C:\inetpub\tdsreceiver</span>`\web.config` file
* Update the following configuration:
  * `WebService` element:
    * `OpenAM=https://`[*FQDN or IP address of OpenAM server*{: style="color: #f00;"}]`/auth/oauth2/tokeninfo`
  * `connectionStrings` element:
    *  `TDSQC`: [*Connection information to communicate with the MSSQL Server that supports the TDS Receiver*{: style="color: #f00;"}]
      * `Data Source=`[*The FQDN or IP address of the MSSQL Server that supports the TDS Receiver*{: style="color: #f00;"}]
      * `Initial Catalog=`[*The name of the database that supports the TDS Receiver; use **OSS_TIS** if following this guide*{: style="color: #f00;"}]
      * `User id=`[*The user account that has read/write access to the database that supports the TDS Receiver*{: style="color: #f00;"}]
      * `Password=`[*The password for the user account configured in the **User id** section of the connection string*{: style="color: #f00;"}]
* `appSettings` element:
  * `LogFilePath=`[*The path and file name to where the TDS Receiver should write log entries*{: style="color: #f00;"}]
  * `AuthTokenCache:MaxSize=`[*The max number of tokens to store in the cache*{: style="color: #f00;"})]
  * `AuthTokenCache:PurgeCount=`[*The number of entries to purge if the count is >= MaxSize*{: style="color: #f00;"}]
  * `AuthTokenCache:SlidingExpirationMinutes=`[*If the cache is not accessed in this number of minutes, it will be dumped from memory*{: style="color: #f00;"}]
  * **NOTE:** The AuthTokenCache stores authentication tokens sent with requests in order to decrease the number of calls to OpenAM in order to validate the token.

* Example of the configured `web.config` sections:

<div class="highlighter-rouge">
<pre class="highlight">
<code>
  &lt;WebServiceSettings&gt;
    &lt;WebService name="OpenAM" url="https://<span class="placeholder-example">sso-dev.sbtds.org</span>/auth/oauth2/tokeninfo" /&gt;
  &lt;/WebServiceSettings&gt;

  &lt;connectionStrings&gt;
    &lt;add name="TDSQC" connectionString="Data Source=<span class="placeholder-example">tis-deployment.cugsexobhx8t.us-west-2.rds.amazonaws.com</span>;Initial Catalog=<span class="placeholder-example">OSS_TIS</span>;User id=<span class="placeholder-example">remoteuser</span>;Password=<span class="placeholder-example">[redacted]</span>" providerName="System.Data.SqlClient" /&gt;
  &lt;/connectionStrings&gt;

  &lt;appSettings&gt;
    &lt;add key="LogFilePath" value="<span class="placeholder-example">C:\inetpub\logs\TISServicesLog.txt</span>"/&gt;
    &lt;add key="AuthTokenCache:MaxSize" value="<span class="placeholder-example">100</span>"/&gt;
    &lt;add key="AuthTokenCache:PurgeCount" value="<span class="placeholder-example">9</span>"/&gt;
    &lt;add key="AuthTokenCache:SlidingExpirationMinutes" value="<span class="placeholder-example">240</span>"/&gt;
  &lt;/appSettings&gt;
</code>
</pre>
</div>

## Deploy the TIS Scoring Daemon

### Build the TIS Scoring Daemon
* Clone the TIS repository to a machine that can build .NET applications:
  * `hg clone https://`[*your BitBucket user or team name*{: style="color: #f00;"}]`/sbacoss/testintegrationsystem_release`
  * Example:
    * `hg clone https://`<span class="placeholder-example">jjohnson-fw@bitbucket.org</span>`/sbacoss/testintegrationsystem_release`
* Launch Visual Studio
* Open the `TISSCoringDaemon.sln`

{% include checklist/windows_vs_publish.md %}

### Deploy the TIS Scoring Daemon
* Connect to the AWS Windows server via RDP
* Create a directory where the TIS Scoring Daemon will be deployed
  * The TDS Receiver is a web application, thus must be accessible by IIS
  * Example:  `C:\inetpub\`<span class="placeholder-example">tis_scoring</span>
* From the machine where the TIS Scoring Daemon was built, copy the *entire contents* of the directory where the **Publish** wizard deployed the component into the directory created in the previous step.

### Configure a TIS Scoring Daemon Website in IIS
* Launch the **Internet Information Services Manager**
  * Click **Start** button in lower-left corner (leftmost control on toolbar)
  * Click the down arrow (if the **Internet Information Services Manager** does not appear)
  * Search for and launch the **Internet Information Services Manager**
* Right click on the **Default Web Site**
  * Choose **Manage Website...**
  * Choose **Stop**
* Right click on **Sites** and choose **Add Website...**

![Add website within IIS](/res/images/checklist/iis_01_add_site.png){: width="100%"}

* Provide the following details in the dialog that appears:
  * Site name: [*Choose a meaningful name*{: style="color: #f00;"}]
  * Application Pool: [*Choose an exisitng Application Pool, or allow IIS to create a new Application Pool for this site (**recommended**)*{: style="color: #f00;"}]
  * Physical Path: [*The path to where the TIS Scoring components have been deployed*{: style="color: #f00;"}]
  * Binding:  [*Choose an available port*{: stlye="color: #f00;"}]
  * Host name:  [***OPTIONAL:*** *Provide a host name*{: style="color: #f00;"}]

* Screenshot showing example values for the TIS Scoring Daemon website:

![Add website details](/res/images/checklist/iis_03_tis_scoring_site_details.png){: width="100%"}

### Configure the TIS Scoring Daemon

#### Generate a Machine Key
* In **IIS Manager**, choose the website for the TIS Scoring Daemon  (e.g. <span class="placeholder-example">TIS Scoring</span>)
* Click on **Machine Key**:

![Add website details](/res/images/checklist/iis_04_tis_scoring_machine_key.png){: width="100%"}

* Click the **Generate Keys** link on the righthand side of the window (circled in red below):

![Add website details](/res/images/checklist/iis_05_tis_scoring_generate_keys.png){: width="100%"}

#### Turn Off Application Pool Recycling
* In **IIS Manager**, choose the **TIS Scoring** Application Pool.
* Right-click on the **TIS Scoring** Application Pool and choose **Advanced Settings**
* Set the **Regular Time Interval (minutes)** setting to **0**, as shown in the screenshot below:

![Disable Application Pool recycling](/res/images/checklist/iis_06_tis_scoring_disable_recycling.png){: width="100%"}

#### Configure Database Connection Information
* Use **File Explorer** to navigate to [*Path/to/TIS Scoring Daemon/Website*{: style="color: #f00;"}]`\Configuration`
  * Example path:  <span class="placeholder-example">C:\inetpub\tis_scoring\Configuration</span>
* Edit the [*Path\to\TDS Receiver*{: style="color: #f00;"}]`\database.config` file
* Update the following configuration:
  * `connectionStrings` element:
    * `GEO:Cloud=`[*Connection information to communicate with the MSSQL Server that supports the **OSS_TIS** database*{: style="color: #f00;"}]
      * `Data Source=`[*The FQDN or IP address of the MSSQL Server that supports the **OSS_TIS** database*{: style="color: #f00;"}]
      * `Initial Catalog=`[*The name of the database that supports the TIS Scoring Daemon; use **OSS_TIS** if following this guide*{: style="color: #f00;"}]
      * `User id=`[*The user account that has read/write access to the **OSS_TIS** database*{: style="color: #f00;"}]
      * `Password=`[*The password for the user account configured in the **User id** section of the connection string*{: style="color: #f00;"}]

* Example of the configured `database.config` sections:

<div class="highlighter-rouge">
<pre class="highlight">
<code>&lt;?xml version="1.0"?&gt;

&lt;connectionStrings&gt;
    &lt;clear /&gt;
    &lt;add name="GEO:Cloud" connectionString="Data Source=<span class="placeholder-example">tis-deployment.cugsexobhx8t.us-west-2.rds.amazonaws.com</span>;Initial Catalog=<span class="placeholder-example">OSS_TIS</span>;User id=<span class="placeholder-example">remoteuser</span>;Password=<span class="placeholder-example">[redacted]</span>" providerName="System.Data.SqlClient" /&gt;
&lt;/connectionStrings&gt;</code>
</pre>
</div>

#### Configure Logging
* Use **File Explorer** to navigate to [*Path/to/TIS Scoring Daemon/Website*{: style="color: #f00;"}]`\Configuration`
  * Example path:  <span class="placeholder-example">C:\inetpub\tis_scoring\Configuration</span>
* Edit the [*Path\to\TIS Scoring Daemon Website*{: style="color: #f00;"}]`\logging.config` file
* Update the following configuration:
  * `sharedListeners` element:
    * `fileTrace=` [*Path to log file directory created earlier.  **NOTE:** Do not supply a file name; just a path to where the log file will be written.*{: style="color: #f00;"}]

* Example of the configured `logging.config` sections:

<div class="highlighter-rouge">
<pre class="highlight">
<code>&lt;?xml version="1.0"?&gt;

&lt;!--
NOTE: For local debugging in DebugView turn on "Capture Global Win32"
--&gt;

&lt;system.diagnostics&gt;

  &lt;trace autoflush="true" indentsize="0" /&gt;

  &lt;sharedListeners&gt;
    &lt;add name="sqlTrace" type="TDS.Shared.Logging.TDSTraceListener, TDS.Shared" &gt;&lt;filter type="" /&gt;&lt;/add&gt;
    &lt;add name="consoleTrace" type="AIR.Common.Diagnostics.OutputDebugStringTraceListener, AIR.Common" &gt;&lt;filter type="" /&gt;&lt;/add&gt;
    &lt;add name="fileTrace" type="AIR.Common.Diagnostics.FileTraceListener, AIR.Common" filePrefix="TISScoringDaemon" filePath="<span class="placeholder-example">C:\intepub\logs\</span>" enableUserLogging="false" enableMachineLogging="false" enableDateLogging="false"&gt;&lt;filter type="" /&gt;&lt;/add&gt;
  &lt;/sharedListeners&gt;

  &lt;sources&gt;
    &lt;source name="TDSConfig"&gt;&lt;listeners&gt;&lt;add name="fileTrace" /&gt;&lt;/listeners&gt;&lt;/source&gt;
    &lt;source name="TDSSql"&gt;&lt;listeners&gt;&lt;add name="fileTrace" /&gt;&lt;/listeners&gt;&lt;/source&gt;
    &lt;source name="TDSApplication"&gt;&lt;listeners&gt;&lt;add name="fileTrace" /&gt;&lt;/listeners&gt;&lt;/source&gt;
    &lt;source name="TDSRenderer"&gt;&lt;listeners&gt;&lt;add name="fileTrace" /&gt;&lt;/listeners>&lt;/source&gt;
    &lt;source name="TDSAdaptive"&gt;&lt;listeners&gt;&lt;add name="fileTrace" /&gt;&lt;/listeners>&lt;/source&gt;
  &lt;/sources&gt;

  &lt;switches&gt;
    &lt;add name="TDSConfig" value="Information, ActivityTracing" /&gt;
    &lt;add name="TDSApplication" value="Information, ActivityTracing" /&gt;
    &lt;add name="TDSSql" value="Information" /&gt; &lt;!-- , Verbose --&gt;
    &lt;add name="TDSRenderer" value="Information" /&gt;
    &lt;add name="TDSAdaptive" value="Information" /&gt;
  &lt;/switches&gt;

  &lt;!--
  The possible &lt;switches&gt; values are the following:
    * All- Allows all events through.
    * ActivityTracing- Allows the Stop, Start, Suspend, Transfer, and Resume events through.
    * Verbose- Allows Critical, Error, Warning, Information, and Verbose events through.
    * Information- Allows Critical, Error, Warning, and Information events through.
    * Warning- Allows Critical, Error, and Warning events through.
    * Error- Allows Critical and Error events through.
    * Critical- Allows only Critical events through.
    * Off- Does not allow any events through.
  --&gt;

&lt;/system.diagnostics&gt;</code>
</pre>
</div>

#### Configure Settings
* Use **File Explorer** to navigate to [*Path/to/TIS Scoring Daemon/Website*{: style="color: #f00;"}]`\Configuration`
  * Example path:  <span class="placeholder-example">C:\inetpub\tis_scoring\Configuration</span>
* Edit the [*Path\to\TIS Scoring Daemon Website*{: style="color: #f00;"}]`\settings.config` file
* Update the following configuration:
  * `appSettings` element:
    * `ScoringDaemon.HubTimerIntervalSeconds=`[*Time in seconds that the daemon waits before checking for data to process*{: style="color: #f00;"}]
    * `ScoringDaemon.MachineName=`[*The machine name. If this is not set, the **machine name** will be retrieved and used (using C# `Environment.MachineName`)*{: style="color: #f00;"}]
    * `ScoringDaemon.PendingMins=`[*Determines the number of minutes since the last attempt at scoring when finding new items to rescore. Defaults to **15 minutes** if no value is provided. Used for machine scoring, and not relevant for hand scored items.*{: style="color: #f00;"}]
    * `ScoringDaemon.MinAttempts=`[*The minimum number of attempts at rescoring machine scored items. Defaults to **0** if no value is provided*{: style="color: #f00;"}]
    * `ScoringDaemon.MaxAttempts=`[*The maximum number of attempts at rescoring machine scored items. If scoring attempts is above this value, the item is marked with a status of ScoringError. Defaults to **10** if no value is provided.*{: style="color: #f00;"}]
    * `ScoringDaemon.SessionType=`[*Defaults to **0** if not provided. **0 means online**.*{: style="color: #f00;"}]
    * `ScoringDaemon.MaxItemsReturned=`[*The maximum number of tests to retrieve at a time when looking for pending items that need to be scored.*{: style="color: #f00;"}]
    * `ScoringDaemon.ItemScoringConfigCacheSeconds=`[*Seconds to cache the item scoring configuration. Defaults to **14400 (4 hours)***{: style="color: #f00;"}]
    * `ScoringDaemon.ItemScoringCallBackHostUrl=`[*The URL of this TIS server. **IMPORTANT**: <span style="background-color: #ff0;">The URL must end with a /</span>*{: style="color: #f00;"}]
    * `ScoringDaemon.ItemFormatsRequiringItemKeysForRubric=`[*Defines the item types that need to have their rubrics retrieved from the student application. Defaults to **"ER"** if not provided.*{: style="color: #f00;"}]
    * `ScoringDaemon.StudentAppUrlOverride=`[*Allows the student application to be overriden instead of using the value sent in the TRT.*{: style="color: #f00;"}]
    * `ScoringDaemon.ItemScoringServerUrlOverride=`[*Allows the item scoring server URL to be overriden*{: style="color: #f00;"}]
    * `ScoringDaemon.EnableLocalHostUsageForColocatedApps=`[*Allows the use of localhost instead of a specific URL when the student application and the item scoring are colocated on the same server. Defaults to **False***{: style="color: #f00;"}]

* Example of the configured `settings.config` sections:

<div class="highlighter-rouge">
<pre class="highlight">
<code>&lt;?xml version="1.0"?&gt;

&lt;appSettings&gt;
  &lt;!-- NOTE: if the scoring daemon will be polling for responses to send off for scoring, be sure to
    set the app domain to not recycle....

    Recycling -&gt; Regular Time Interval: 0

    If it's just being used to receive scores back via the HTTP handler (i.e., from THSS), there's no need for this.
    Also, in that case you can bump up the HubTimerIntervalSeconds too.
    --&gt;
  &lt;add key="ScoringDaemon.HubTimerIntervalSeconds" value="<span class="placeholder-example">90</span>"/&gt;
  &lt;add key="ScoringDaemon.MachineName" value="<span class="placeholder-example">MyTISScoringDaemonName</span>"/&gt;
  &lt;add key="ScoringDaemon.PendingMins" value="<span class="placeholder-example">15</span>"/&gt;
  &lt;add key="ScoringDaemon.MaxAttempts" value="<span class="placeholder-example">5</span>"/&gt;
  &lt;add key="ScoringDaemon.ItemScoringCallBackHostUrl" value="<span class="placeholder-example">https://myitemscoring.myserver.org/</span>"/&gt;
  &lt;!-- TISScoringDaemon doesn't have access to the item files/rubrics, so all supported item types should be configured here if the Scoring Deamon will be sending requests.  --&gt;
  &lt;add key="ScoringDaemon.ItemFormatsRequiringItemKeysForRubric" value="<span class="placeholder-example">EQ,GI</span>"/&gt;
  &lt;add key="secureConnectionStrings" value="false"/&gt;
&lt;/appSettings&gt;</code>
</pre>
</div>

## Deploy the TIS Service

### Build the TIS Servcie
* Clone the TIS repository to a machine that can build .NET applications:
  * `hg clone https://`[*your BitBucket user or team name*{: style="color: #f00;"}]`/sbacoss/testintegrationsystem_release`
  * Example:
    * `hg clone https://`<span class="placeholder-example">jjohnson-fw@bitbucket.org</span>`/sbacoss/testintegrationsystem_release`
* Launch Visual Studio
* Open the `TDSQAService\OSSTIS.sln`
* Build the `OSSTIS.sln` using the **Release** configuration

### Deploy the TIS Service
* Connect to the AWS Windows server via RDP
* Create a directory where the TDS Receiver component will be deployed
  * Example: <span class="placeholder-example">C:\sbtds\Services\OSS_TISService</span>
* Copy the content of built TIS Service ([*\Path\to\TIS Service\directory*]`\bin\release`) into the directory (e.g. <span class="placeholder-example">C:\sbtds\Services\OSS_TISService</span>) created during the previous step
* Launch a command prompt
* Run the following command to install and register the Windows service:
  * `cd `[*\Path\to\where\TIS Service\is\deployed*{: style="color: #f00;"}]
  * `C:\Windows\Microsoft.NET\Framework64\v4.0.30319\InstallUtil.exe TISService.exe`
  * Example:
    * `C:\> cd `<span class="placeholder-example">C:\sbtds\Services\OSS_TISService</span>
    * `C:\sbtds\Services\OSS_TISService> C:\Windows\Microsoft.NET\Framework64\v4.0.30319\InstallUtil.exe TISService.exe`


### Configure the TIS Service
* Open [*\Path\to\TIS Service\*{: style="color: #f00;"}]`\TISService.exe.config` in an editor
* Update the following configuration:
  * `connectionStrings` element:
    * `ITEMBANK=`[*Connection information to communicate with the MSSQL Server that supports the **OSS_ItemBank** database*{: style="color: #f00;"}]
      * `Data Source=`[*The FQDN or IP address of the MSSQL Server that supports the **OSS_ItemBank** database*{: style="color: #f00;"}]
      * `Initial Catalog=`[*The name of the database that supports the TIS Service; use **OSS_ItemBank** if following this guide*{: style="color: #f00;"}]
      * `User id=`[*The user account that has read/write access to the **OSS_ItemBank** database*{: style="color: #f00;"}]
      * `Password=`[*The password for the user account configured in the **User id** section of the connection string*{: style="color: #f00;"}]
    * `TDSQC=`[*Connection information to communicate with the MSSQL Server that supports the **OSS_TIS** database*{: style="color: #f00;"}]
      * `Data Source=`[*The FQDN or IP address of the MSSQL Server that supports the **OSS_TIS** database*{: style="color: #f00;"}]
      * `Initial Catalog=`[*The name of the database that supports the TIS Service; use **OSS_TIS** if following this guide*{: style="color: #f00;"}]
      * `User id=`[*The user account that has read/write access to the **OSS_TIS** database*{: style="color: #f00;"}]
      * `Password=`[*The password for the user account configured in the **User id** section of the connection string*{: style="color: #f00;"}]
  * `AuthorizationSettings` element:
    * `name=`[*Name to use as a reference. Matches the **WebServiceSettings\WebService authSettingName** attribute*{:style="color: #f00;"}]
    * `url=`[*OpenAM base url. **IMPORTANT:** <span style="background-color: #ff0;">This is only the base url and does not include the **/auth/oauth2 path** as that is added within the code itself</span>.*{: style="color: #f00;"}]
    * `realm=`[*The realm used by OpenAM; use **/sbac** if following this guide*{: style="color: #f00;"}]
    * `grantType=`[*The type of OAuth grant to conduct;use **password***{: style="color: #f00;"}]
    * `username=`[*Name of user with elevated privileges that exists in OpenDJ*{: style="color: #f00;"}]
    * `password=`[*Password for account cited in **username** attribute*{: style="color: #f00;"}]
    * `clientId=`[*The OpenAM OAuth configured client id. The installation process configures a **pm** client which can be used out of the box. You can view the clients in the OpenAM console by going to the **Access Control** tab -> click **sbac** link -> **Agents** -> **OAuth2.0/OpenID Connect** tab.*{: style="color: #f00;"}]
    * `clientSecret=`[*This is the default password for the "pm" client and should have been changed during installation.  Starting value is **sback12345***{: style="color: #f00;"}]
    * `passwordEncrypted=`[*A boolean value that defines whether the passwords provided in this file are encrypted.*{: style="color: #f00;"}]
  * `ItemScoringSettings` element:
    * `target=`[*WebService target that should be used. Matches the **WebServiceSettings\WebService name** attribute*{: style="color: #f00;"}]
    * `callbackUrl=`[*The callback URL that the scoring server will use to notify TIS of the results. **ItemScoringCallbackRcv.axd** should be used for the Teacher Handscoring target and **ItemScoringCallback.axd** should be used for the Math Equation Scorer.*{: style="color: #f00;"}]
    * `itemTypes=`[*Defines the items that should be included in this group and therefore sent to the defined target. See the **ItemTypes Format** section below for more detail on the format itself*{: style="color: #f00;"}]
    * `scoreStatuses=`[*A comma-separated list of score statuses that should be included. Defaults to **NotScored** if no value is provided.*{: style="color: #f00;"}]
    * `scoreInvalidations=`[*Defines if invalidations be scored. Defaults to **True** if no value is provided.*{: style="color: #f00;"}]
    * `updateSameReportingVersion=`[*Defaults to **True** if no value is provided.*{: style="color: #f00;"}]
    * `isHandscoringTarget=`[*Set to True for the HandscoringTSS target and to False for the HandscoringTDSUnscored (e.g. equation scorer). Defaults to **False** if value is not provided.*{: style="color: #f00;"}]
    * `batchRequest=`[*Defines if results should be sent as batches or individually. The **Teacher Handscoring System** can handle batch requests and therefore can be set to **True**. The **Equation Scoring** target can not and therefore must be set to **False** or left blank. Defaults to **False** if not provided.*{: style="color: #f00;"}]
  * `appSettings` element:
    * `ServiceName=`[***IMPORTANT:** <span style="background-color: #ff0;">This should only be changd in rare circumstances where there are multiple Services accessing the same TIS database. This value is used in the **OSS_TIS.dbo.TestNameLookUp InstanceName** column to determine which tests this service processes.</span>*{: style="color: #f00;"}]
    * `MaxErrorEMails=`[*The max number of error emails to send.*{: style="color: #f00;"}]
    * `FatalErrorsTo=`[*Email address where fatal errors are sent.*{: style="color: #f00;"}]
    * `FatalErrorsCc=`[*Email address where fatal errors are sent via CC.*{: style="color: #f00;"}]
    * `EmailAlertForWarnings=`[*Boolean value defining whether warning notifications should be sent via email.*{: style="color: #f00;"}]
    * `WarningsTo=`[*Email address where warnings are sent if **EmailAlertForWarnings** is set to **True**.*{: style="color: #f00;"}]
    * `WarningsCc=`[*Email address where warnings are sent via CC if **EmailAlertForWarnings** is set to **True**.*{: style="color: #f00;"}]
    * `ScoringEnvironment=`[*Must match the value in **OSS_TestScoringConfigs.dbo.ComputationLocations** table which is **TIS** by default.*{: style="color: #f00;"}]
    * `ClientName=`[*The client name of the tests TIS is processing. For IRP packages this would be "SPAC_PT." When tests are loaded, the client name from the test is used to populate the **OSS_COnfigs.dbo.Client_TestMode**. If you are not sure what to set this value to check this table after loading up your tests.*{: style="color: #f00;"}]
    * `EventLogName=`[*The name of the Windows Event Log that will be created and used for warnings and errors. NOTE: The user that this service is running as will need to have access to create and write to the Event Log. By default the Local System should have access.*{: style="color: #f00;"}]
    * `EventLogSource=`[*The source name used in the Event Log.*{: style="color: #f00;"}]
    * `ErrorLog=`[*Path to a log file used by the service. Make sure the user running the service has write access to this path.*{: style="color: #f00;"}]
    * `SendToHandscoring=`[*Boolean value that controls whether items are sent to the Teacher Handscoring System or not.*{: style="color: #f00;"}]
    * `IgnoreHandscoringDuplicates=`[*Should duplicates be ignored when processing handscoring results.*{: style="color: #f00;"}]
    * `Environment=`[*Set to Production when deployed live. If set to "Local" or "Dev" then it allows for the TDS server to not be validated. See **TDSSessionDatabases** below.*{: style="color: #f00;"}]
    * `IdleSleepTime=`[*The amount of time (in milliseconds) to sleep when there is no work to be done.*{: style="color: #f00;"}]
    * `LoopSleepTime=`[*The amount of time the thread sleeps (in milliseconds) at each iteration of the loop*{: style="color: #f00;"}]
    * `NumberOfGeneralThreads=`[*The total number of threads used for all subjects, except writing.*{: style="color: #f00;"}]
    * `WaitForWorkerThreadsOnStopSeconds=`[*When the service is stopped, the system will wait this long for all worker threads to complete. Defaults to **120 seconds**.*{: style="color: #f00;"}]
    * `LongDbCommandTimeout=`[*Database command timeout in seconds*{: style="color: #f00;"}]
    * `TDSSessionDatabases=`[*List of one or more TDS applications that are allowed to send test results to this TIS intance. The format is **{server},{database};{server},{database}**; The database should almost always be set to "session" and the **{server}** should be set to the machine name of the TDS server. TIS validates that the data coming in is from one of those servers by looking at the TRT file &lt;Opportunity&gt; server and database values. **IMPORTANT:** <span style="background-color: #ff0;">If Environment is starts with "Dev" or "Local" then this validation is skipped</span>.*{: style="color: #f00;"}]

#### ItemTypes Format
The item types string follows a specific format that can be summarized like so: `{itemType}:{itemKey},{itemKey}:{isExcludedItems};{itemType}`... where only the `{itemType}` is required.

In it's simplest form, the string will contain a semicolon separated list of item types that should be sent to this particular target. This would look like: `SA;WER;TI`.

Including one or more `{itemKey}`'s limits the items that will be included for this `{itemType}` to only those listed. So `SA;WER;TI:200-25662,200-19678` means that all `SA` and `WER` items are included and only item `200-25662` and `200-19678` are included for the TI type.

The last option `{isExcludedItems}` is a boolean value that defines if the list of `{itemKey}`'s provided should be included or exceluded. If it isn't provided it defaults to **true**, meaning the items are included. Therefore `SA;WER;TI:200-25662,200-19678:true` means that all `SA` and `WER` items are included and all `TI` items except `200-25662` and `200-19678` will be included.

* Example of the <span class="placeholder-example">C:\sbtds\Services\OSS_TISService</span>`\TISService.exe.config`:

<div class="highlighter-rouge">
<pre class="highlight">
<code>&lt;?xml version="1.0" encoding="utf-8" ?&gt;
&lt;configuration&gt;
  &lt;configSections&gt;
    &lt;section name="WebServiceSettings" type="AIR.Configuration.WebServiceConfig, AIR.Configuration, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" allowDefinition="Everywhere" allowExeDefinition="MachineToApplication" restartOnExternalChanges="true" /&gt;
    &lt;section name="AuthorizationSettings" type="AIR.Configuration.AuthorizationConfig, AIR.Configuration, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" allowDefinition="Everywhere" allowExeDefinition="MachineToApplication" restartOnExternalChanges="true" /&gt;
    &lt;section name="ItemScoringSettings" type="AIR.Configuration.ItemScoringConfig, AIR.Configuration, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" allowDefinition="Everywhere" allowExeDefinition="MachineToApplication" restartOnExternalChanges="true" /&gt;
  &lt;/configSections&gt;

  &lt;connectionStrings&gt;
    &lt;add name="ITEMBANK" connectionString="Data Source=<span class="placeholder-example">tis-deployment2.cugsexobhx8t.us-west-2.rds.amazonaws.com</span>;Initial Catalog=<span class="placeholder-example">OSS_ItemBank</span>;User id=<span class="placeholder-example">remoteuser</span>;Password=<span class="placeholder-example">[redacted]</span>" providerName="System.Data.SqlClient" /&gt;
    &lt;add name="TDSQC" connectionString="Data Source=<span class="placeholder-example">tis-deployment2.cugsexobhx8t.us-west-2.rds.amazonaws.com</span>;Initial Catalog=<span class="placeholder-example">OSS_TIS</span>;User id=<span class="placeholder-example">remoteuser</span>;Password=<span class="placeholder-example">[redacted]</span>" providerName="System.Data.SqlClient" /&gt;
  &lt;/connectionStrings&gt;

  &lt;WebServiceSettings&gt;
    &lt;!-- configure rest targets; handscoring targets must start with or equal "Handscoring" --&gt;
    &lt;WebService name="HandscoringTSS" url="http://<span class="placeholder-example">54.200.42.254</span>/api/test/submit" /&gt;
    &lt;WebService name="HandscoringTDSUnscored" url="http://<span class="placeholder-example">54.186.182.136:8084</span>" /&gt;
    &lt;WebService name="ART" url="http://<span class="placeholder-example">54.186.87.166:8080</span>/rest" authSettingName="<span class="placeholder-example">OAuth</span>" /&gt;
    &lt;WebService name="DW1" url="<span class="placeholder-example">https://myDataWarehouseServer/endpoint</span>" authSettingName="<span class="placeholder-example">OAuthDW1</span>" /&gt;
    &lt;WebService name="DW2" url="<span class="placeholder-example">https://myOtherDataWarehouseServer/endpoint</span>" authSettingName="<span class="placeholder-example">OAuthDW2</span>" /&gt;
  &lt;/WebServiceSettings&gt;

  &lt;AuthorizationSettings&gt;
    &lt;!-- Can configure 1 or more oauth servers/accounts that can be used by WebService settings above --&gt;
    &lt;Authorization name="OAuth" url="https://<span class="placeholder-example">sso-deployment.sbtds.org</span>/" realm="<span class="placeholder-example">/sbac</span>" grantType="password" username="<span class="placeholder-example">prime.user@example.com</span>" password="<span class="placeholder-example">[redacted]</span>" clientId="<span class="placeholder-example">pm</span>" clientSecret="<span class="placeholder-example">[redacted]</span>" passwordEncrypted="<span class="placeholder-example">false</span>" /&gt;
    &lt;Authorization name="<span class="placeholder-example">OAuthDW1</span>" url="<span class="placeholder-example">https://myOpenAMserver2/endpoint/</span>" realm="<span class="placeholder-example">/sbac</span>" grantType="password" username="<span class="placeholder-example">name@example.com</span>" password="<span class="placeholder-example">[redacted]</span>" clientId="<span class="placeholder-example">tis</span>" clientSecret="<span class="placeholder-example">[redacted]</span>" /&gt;
    &lt;Authorization name="<span class="placeholder-example">OAuthDW2</span>" url="<span class="placeholder-example">https://myOpenAMserver3/endpoint/</span>" realm="<span class="placeholder-example">/sbac</span>" grantType="password" username="<span class="placeholder-example">name@example.com</span>" password="<span class="placeholder-example">[redacted]</span>" clientId="<span class="placeholder-example">tis</span>" clientSecret="<span class="placeholder-example">[redacted]</span>" /&gt;
  &lt;/AuthorizationSettings&gt;

  &lt;ItemScoringSettings&gt;
    &lt;ItemScoring target="<span class="placeholder-example">HandscoringTSS</span>"
        callbackUrl="http://<span class="placeholder-example">54.187.75.133</span>/ItemScoringCallbackRcv.axd"
        itemTypes="<span class="placeholder-example">SA;WER;TI:200-25662,200-19678,200-6117;EQ:200-19679,200-13312</span>"
        isHandscoringTarget="<span class="placeholder-example">true</span>"
        batchRequest="<span class="placeholder-example">true</span>" /&gt;
    &lt;ItemScoring target="<span class="placeholder-example">HandscoringTDSUnscored</span>"
        callbackUrl="http://<span class="placeholder-example">54.187.75.133</span>/ItemScoringCallback.axd"
        itemTypes="<span class="placeholder-example">EBSR;EQ:200-19679,200-13312:true;ER;ETC;GI;HT;HTQ;MC;MI;MS;NL;SA;TI:200-25662,200-19678,200-6117:true;TUT;WER;WIT</span>"
        scoreStatuses="<span class="placeholder-example">WaitingForMachineScore</span>" /&gt;
  &lt;/ItemScoringSettings&gt;

  &lt;appSettings&gt;
    &lt;add key="ServiceName" value="<span class="placeholder-example">OSS_TISService</span>"/&gt;
    &lt;add key="MaxErrorEMails" value="<span class="placeholder-example">25</span>"/&gt;

    &lt;add key="FatalErrorsTo" value="<span class="placeholder-example">tis.admin@example.com</span>"/&gt;
    &lt;add key="FatalErrorsCc" value="<span class="placeholder-example">tis.admin@example.com</span>"/&gt;
    &lt;add key="EmailAlertForWarnings" value="<span class="placeholder-example">true</span>"/&gt;
    &lt;add key="WarningsTo" value="<span class="placeholder-example">tis.admin@example.com</span>"/&gt;
    &lt;add key="WarningsCc" value="<span class="placeholder-example">tis.admin@example.com</span>"/&gt;

    &lt;add key="ScoringEnvironment" value="<span class="placeholder-example">TIS</span>" /&gt;
    &lt;add key="ClientName" value="<span class="placeholder-example">SBAC_PT</span>"/&gt;
    &lt;add key="EventLogName" value="<span class="placeholder-example">OSS_TISEventLog</span>" /&gt;
    &lt;add key="EventLogSource" value="<span class="placeholder-example">OSS_TIS</span>" /&gt;
    &lt;add key="ErrorLog" value="<span class="placeholder-example">C:\inetpub\logs\OSS_TIS_ResultLog.txt</span>"/&gt;

    &lt;add key="SendToHandscoring" value="<span class="placeholder-example">true</span>"/&gt;
    &lt;add key="IgnoreHandscoringDuplicates" value="<span class="placeholder-example">true</span>"/&gt;
    &lt;add key="Environment" value="<span class="placeholder-example">Dev</span>" /&gt;

    &lt;add key="IdleSleepTime" value="<span class="placeholder-example">1000</span>" /&gt;
    &lt;add key="LoopSleepTime" value="<span class="placeholder-example">1</span>" /&gt;
    &lt;add key="NumberOfGeneralThreads" value="<span class="placeholder-example">20</span>"/&gt;
    &lt;add key="WaitForWorkerThreadsOnStopSeconds" value="<span class="placeholder-example">120</span>"/&gt;
    &lt;add key="LongDbCommandTimeout" value="<span class="placeholder-example">90</span>" /&gt;

    &lt;add key="TDSSessionDatabases" value="<span class="placeholder-example">server,database;otherserver,otherdatabase</span>"/&gt;
  &lt;/appSettings&gt;

  &lt;system.net&gt;
    &lt;defaultProxy&gt;
      &lt;proxy usesystemdefault="False"/&gt;
    &lt;/defaultProxy&gt;
    &lt;mailSettings&gt;
      &lt;smtp deliveryMethod="SpecifiedPickupDirectory" from="<span class="placeholder-example">tis.admin@example.com</span>"&gt;
        &lt;specifiedPickupDirectory pickupDirectoryLocation="<span class="placeholder-example">C:\EmailPickup</span>"/&gt;
      &lt;/smtp&gt;
    &lt;/mailSettings&gt;
  &lt;/system.net&gt;
&lt;/configuration&gt;</code>
</pre>
</div>

* Launch the **Services** pane
* Select the **OSS_TISService**
  * ***IMPORTANT:***{: style="color: #f00;"} *There is also a **TISService** listed in the **Services** pane; ignore this service.  Only the **OSS_TISService** Windows Service is relevant.*{: style="background-color: #ff0;"}
* Set the **OSS_TISService** to start automatically by right-clicking on the **OSS_TISService** and choosing **Properties**
* Example screenshot of setting the **OSS_TISService** to start automatically when the server starts up:

![Set OSS_TISService to auto start](/res/images/checklist/win_tissvc_01_auto_start.png){: width="100%""}

## Verification - TIS Service

* From the **Services Pane**, start the **OSS_TISService**.  The service should start without error.

[back to Deployment Checklists](index.html)